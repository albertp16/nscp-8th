<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASEP Chapter 3 - Sensitivity Analysis</title>

    <!-- Foundation CSS for styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/css/foundation.min.css">

    <!-- Plotly.js for plotting -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- jQuery (required by Foundation) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="./interpolate.js"></script>
    <script src="./nscp_15.js"></script>
    <script src="./nscp_24.js"></script>
    <script src="./generate_latex.js"></script>
</head>

<body>
    <div id="app" class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="cell">
                <center><img src="./asep-logo.jpg" alt="ASEP Logo" style="max-width:15%; height: auto;"></center>
                <center><h2>{{ title }}</h2></center>
            </div>
        </div>

        <div class="grid-x grid-padding-x">
            <div class="cell medium-6">
                <label>City
                    <select v-model="selectedCity">
                        <option v-for="city in cities" :value="city">{{ city.name }}</option>
                    </select>
                </label>
            </div>
            <div class="cell medium-6">
                <label>Response Modification Factor
                    <select v-model="materialType">
                        <option value="concrete">SMRF (Concrete)</option>
                        <option value="steel">SMRF (Steel)</option>
                        <option value="concrete_dual">Concrete Dual</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="grid-x grid-padding-x">
            <div class="cell medium-6">
                <button @click="generateGraph" class="button large">Generate Graph</button>
            </div>
        </div>

        <!-- Display calculated value -->
        <div class="grid-x grid-padding-x">
            <div class="cell">
                <p>DATA: SAM {{reportss_sam}}, {{s1}} SHADE {{ss2}}, {{ss12}}</p>
            </div>
        </div>

        <!-- Plot and differences area -->
        <div v-for="soilType in soilTypes" class="grid-x grid-padding-x">
            <div class="cell medium-6">
                <div :id="'graph_' + soilType" style="width:100%;height:500px;"></div>
            </div>
            <div class="cell medium-6">
                <table class="hover">
                    <thead>
                        <tr>
                            <th>Period (sec)</th>
                            <th>Spectral Acceleration (NSCP)</th>
                            <th>Spectral Acceleration (SHADE)</th>
                            <th>Spectral Acceleration (SAM)</th>
                            <th>NSCP vs SAM (%)</th>
                            <th>NSCP vs SHADE (%)</th>
                            <th>SAM vs SHADE (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="period in fixedPeriods">
                            <td>{{ period }}</td>
                            <td>{{ getSpectralAcceleration(soilType, period, 'nscp') }}</td>
                            <td>{{ getSpectralAcceleration(soilType, period, 'shade') }}</td>
                            <td>{{ getSpectralAcceleration(soilType, period, 'sam') }}</td>
                            <td>{{ calculateDifference(soilType, period, 'nscp', 'sam') }}</td>
                            <td>{{ calculateDifference(soilType, period, 'nscp', 'shade') }}</td>
                            <td>{{ calculateDifference(soilType, period, 'sam', 'shade') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Foundation JS -->
    <script src="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/js/foundation.min.js"></script>

    <script>
        $(document).ready(function () {
            $(document).foundation();
        });

        new Vue({
            el: "#app",
            data: {
                title: "ASEP Chapter 3 Committee - Sensitivity Analysis",
                selectedCity: null,
                materialType: "concrete",
                soilTypes: ["s_a", "s_b", "s_c", "s_d", "s_e"],
                fixedPeriods: [0.1, 0.2, 0.5, 1, 1.5, 2, 2.5, 3, 4, 5],
                dataBySoilType: {},
                cities: [
                    { name: "Mati, Davao Oriental", fault_input: 2.6, ss_shade: 2.6, s1_shade: 0.7, ss_sam: 2.95, s1_sam: 1.1 },
                    { name: "Manila", fault_input: 9.6, ss_shade: 1.59, s1_shade: 0.64, ss_sam: 1.26, s1_sam: 0.51 },
                    // Add more cities as needed...
                ]
            },
            mounted() {
                this.selectedCity = this.cities[0];
                this.materialType = "concrete";
            },
            methods: {
                generateGraph() {
                    const city = this.selectedCity;
                    const { name, fault_input: fault, ss_sam: ss, s1_sam: s1, ss_shade: ss2, s1_shade: ss12 } = city;

                    this.soilTypes.forEach((soilType) => {
                        const data = generateSensivity(name, this.materialType, fault, soilType, ss, s1, ss2, ss12);
                        const period = data.period;

                        // Store data for each soil type for percentage calculation
                        this.dataBySoilType[soilType] = {
                            period: data.period,
                            nscp: data.nscp15,
                            sam: data.sam,
                            shade: data.shade
                        };

                        const traces = [
                            {
                                x: data.period,
                                y: data.nscp15,
                                mode: 'lines',
                                name: 'NSCP 2015',
                                line: { color: 'blue' }
                            },
                            {
                                x: data.period,
                                y: data.sam,
                                mode: 'lines',
                                name: 'SAM',
                                line: { color: 'red' }
                            },
                            {
                                x: data.period,
                                y: data.shade,
                                mode: 'lines',
                                name: 'SHADE',
                                line: { color: 'green' }
                            }
                        ];

                        const layout = {
                            title: `Base Shear Coefficient vs Period for ${name} (Soil Type: ${soilType.toUpperCase()})`,
                            xaxis: { title: 'Period (sec)' },
                            yaxis: { title: 'Base Shear Coefficient' }
                        };

                        Plotly.newPlot(`graph_${soilType}`, traces, layout);
                    });
                },
                calculateDifference(soilType, fixedPeriod, series1, series2) {
                    const data = this.dataBySoilType[soilType];
                    if (!data) return "-";

                    // Find the closest period in the generated data
                    const closestIndex = data.period.reduce((prevIndex, curr, index) => {
                        return Math.abs(curr - fixedPeriod) < Math.abs(data.period[prevIndex] - fixedPeriod) ? index : prevIndex;
                    }, 0);

                    const value1 = data[series1][closestIndex];
                    const value2 = data[series2][closestIndex];

                    // Calculate percentage difference
                    if (value1 === 0 || isNaN(value1) || isNaN(value2)) return "-";
                    const percentageDifference = ((value1 - value2) / value1) * 100;

                    return isNaN(percentageDifference) ? "-" : percentageDifference.toFixed(2) + "%";
                },
                getSpectralAcceleration(soilType, fixedPeriod, series) {
                    const data = this.dataBySoilType[soilType];
                    if (!data) return "-";

                    // Find the closest period in the generated data
                    const closestIndex = data.period.reduce((prevIndex, curr, index) => {
                        return Math.abs(curr - fixedPeriod) < Math.abs(data.period[prevIndex] - fixedPeriod) ? index : prevIndex;
                    }, 0);

                    const value = data[series][closestIndex];
                    return isNaN(value) ? "-" : value.toFixed(4);
                }
            }
        });
    </script>
</body>

</html>
